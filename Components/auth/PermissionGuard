import { useQuery } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';

export const usePermissions = () => {
  const { data: user } = useQuery({
    queryKey: ['currentUser'],
    queryFn: () => base44.auth.me(),
    retry: false
  });

  const canAccessCentrais = () => {
    return user?.perfil === 'master';
  };

  const canAccessCooperativas = () => {
    return ['master', 'central'].includes(user?.perfil);
  };

  const canAccessPontosAtendimento = () => {
    return ['master', 'central', 'cooperativa'].includes(user?.perfil);
  };

  const canAccessCooperados = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento'].includes(user?.perfil);
  };

  const canAccessCartoes = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento'].includes(user?.perfil);
  };

  const canAccessTransacoes = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento'].includes(user?.perfil);
  };

  const canAccessFaturas = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento'].includes(user?.perfil);
  };

  const canAccessRelatorios = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento', 'admin', 'gerente'].includes(user?.perfil);
  };

  const canAccessUsuarios = () => {
    return ['master', 'central', 'cooperativa', 'admin'].includes(user?.perfil);
  };

  const canAccessConfiguracoes = () => {
    return ['master', 'central', 'cooperativa'].includes(user?.perfil);
  };

  const canAccessDashboard = () => {
    return ['master', 'central', 'cooperativa', 'ponto_atendimento', 'admin', 'gerente', 'atendente'].includes(user?.perfil);
  };

  const filterDataByCentral = (data, centralIdField = 'central_id') => {
    if (!user || user.perfil === 'master') return data;
    if (user.perfil === 'central') {
      return data.filter(item => item[centralIdField] === user.central_id);
    }
    return data;
  };

  const filterDataByCooperativa = (data, cooperativaIdField = 'cooperativa_id') => {
    if (!user || ['master', 'central'].includes(user.perfil)) return data;
    if (user.perfil === 'cooperativa') {
      return data.filter(item => item[cooperativaIdField] === user.cooperativa_id);
    }
    return data;
  };

  const filterDataByPontoAtendimento = (data, pontoIdField = 'ponto_atendimento_id') => {
    if (!user || ['master', 'central', 'cooperativa'].includes(user.perfil)) return data;
    if (user.perfil === 'ponto_atendimento') {
      return data.filter(item => item[pontoIdField] === user.ponto_atendimento_id);
    }
    return data;
  };

  return {
    user,
    canAccessCentrais,
    canAccessCooperativas,
    canAccessPontosAtendimento,
    canAccessCooperados,
    canAccessCartoes,
    canAccessTransacoes,
    canAccessFaturas,
    canAccessRelatorios,
    canAccessUsuarios,
    canAccessConfiguracoes,
    canAccessDashboard,
    filterDataByCentral,
    filterDataByCooperativa,
    filterDataByPontoAtendimento
  };
};
