import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { base44 } from '@/api/base44Client';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { FileText, Download, Clock, CheckCircle2, AlertCircle, Plus, Calendar } from 'lucide-react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { format } from 'date-fns';

export default function Relatorios() {
  const [isFormOpen, setIsFormOpen] = useState(false);
  const [formData, setFormData] = useState({
    tipo_relatorio: '',
    periodo_inicio: '',
    periodo_fim: '',
    cooperativa_id: '',
    formato: 'csv'
  });

  const queryClient = useQueryClient();

  const { data: relatorios = [], isLoading } = useQuery({
    queryKey: ['relatorios'],
    queryFn: () => base44.entities.Relatorio.list('-created_date')
  });

  const { data: cooperativas = [] } = useQuery({
    queryKey: ['cooperativas'],
    queryFn: () => base44.entities.Cooperativa.list()
  });

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Relatorio.create({
      ...data,
      status: 'processando'
    }),
    onSuccess: () => {
      queryClient.invalidateQueries(['relatorios']);
      setIsFormOpen(false);
      setFormData({
        tipo_relatorio: '',
        periodo_inicio: '',
        periodo_fim: '',
        cooperativa_id: '',
        formato: 'csv'
      });
    }
  });

  const tiposRelatorio = [
    { value: 'cartoes_atraso', label: 'Cartões em Atraso' },
    { value: 'cadastral_cartoes', label: 'Cadastral de Cartões' },
    { value: 'cessao_credito', label: 'Cessão de Crédito (Honra de Aval)' },
    { value: 'pagamentos', label: 'Pagamentos' },
    { value: 'faturas_pagas', label: 'Faturas Pagas' },
    { value: 'parcelamentos', label: 'Parcelamentos' },
    { value: 'parcelamentos_rotativos', label: 'Parcelamentos Rotativos' },
    { value: 'anuidades', label: 'Anuidades' },
    { value: 'resgates_pontos', label: 'Resgates do Programa de Recompensas' },
    { value: 'transacoes', label: 'Transações (Débito e Crédito)' },
    { value: 'ajustes_central', label: 'Ajustes da Central' },
    { value: 'cartoes_bloqueados', label: 'Cartões Bloqueados por Emissão' },
    { value: 'cadoc_3040', label: 'CADOC 3040 - Coobrigações' },
    { value: 'receitas_despesas', label: 'Receitas e Despesas' },
    { value: 'limites_gerencial', label: 'Limites Gerencial' },
    { value: 'irpj', label: 'IRPJ - Imposto de Renda' }
  ];

  const statusColors = {
    processando: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    concluido: 'bg-emerald-100 text-emerald-700 border-emerald-200',
    erro: 'bg-red-100 text-red-700 border-red-200'
  };

  const statusIcons = {
    processando: Clock,
    concluido: CheckCircle2,
    erro: AlertCircle
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    createMutation.mutate(formData);
  };

  const relatoriosPorTipo = tiposRelatorio.reduce((acc, tipo) => {
    acc[tipo.value] = relatorios.filter(r => r.tipo_relatorio === tipo.value).length;
    return acc;
  }, {});

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card className="border-t-4 border-t-[#4A9B8E]">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-slate-600">Total Relatórios</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <span className="text-3xl font-bold text-slate-800">{relatorios.length}</span>
              <div className="p-3 rounded-xl bg-[#4A9B8E]/10">
                <FileText className="w-6 h-6 text-[#4A9B8E]" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-t-4 border-t-yellow-500">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-slate-600">Processando</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <span className="text-3xl font-bold text-slate-800">
                {relatorios.filter(r => r.status === 'processando').length}
              </span>
              <div className="p-3 rounded-xl bg-yellow-50">
                <Clock className="w-6 h-6 text-yellow-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-t-4 border-t-emerald-500">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-slate-600">Concluídos</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <span className="text-3xl font-bold text-slate-800">
                {relatorios.filter(r => r.status === 'concluido').length}
              </span>
              <div className="p-3 rounded-xl bg-emerald-50">
                <CheckCircle2 className="w-6 h-6 text-emerald-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="border-t-4 border-t-red-500">
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-slate-600">Com Erro</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <span className="text-3xl font-bold text-slate-800">
                {relatorios.filter(r => r.status === 'erro').length}
              </span>
              <div className="p-3 rounded-xl bg-red-50">
                <AlertCircle className="w-6 h-6 text-red-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      <Card className="border-t-4 border-t-[#4A9B8E]">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="text-2xl">Relatórios Disponíveis</CardTitle>
              <p className="text-sm text-slate-500 mt-1">Geração e download de relatórios</p>
            </div>
            <Dialog open={isFormOpen} onOpenChange={setIsFormOpen}>
              <DialogTrigger asChild>
                <Button className="bg-[#4A9B8E] hover:bg-[#3A7B6E]">
                  <Plus className="w-4 h-4 mr-2" />
                  Novo Relatório
                </Button>
              </DialogTrigger>
              <DialogContent className="max-w-2xl">
                <DialogHeader>
                  <DialogTitle>Gerar Novo Relatório</DialogTitle>
                </DialogHeader>
                <form onSubmit={handleSubmit} className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="tipo_relatorio">Tipo de Relatório *</Label>
                    <Select
                      value={formData.tipo_relatorio}
                      onValueChange={(value) => setFormData({ ...formData, tipo_relatorio: value })}
                      required
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Selecione o tipo..." />
                      </SelectTrigger>
                      <SelectContent>
                        {tiposRelatorio.map(tipo => (
                          <SelectItem key={tipo.value} value={tipo.value}>
                            {tipo.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label htmlFor="periodo_inicio">Período Início</Label>
                      <Input
                        id="periodo_inicio"
                        type="date"
                        value={formData.periodo_inicio}
                        onChange={(e) => setFormData({ ...formData, periodo_inicio: e.target.value })}
                      />
                    </div>
                    <div className="space-y-2">
                      <Label htmlFor="periodo_fim">Período Fim</Label>
                      <Input
                        id="periodo_fim"
                        type="date"
                        value={formData.periodo_fim}
                        onChange={(e) => setFormData({ ...formData, periodo_fim: e.target.value })}
                      />
                    </div>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="cooperativa_id">Cooperativa (Opcional)</Label>
                    <Select
                      value={formData.cooperativa_id}
                      onValueChange={(value) => setFormData({ ...formData, cooperativa_id: value })}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Todas as cooperativas" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value={null}>Todas</SelectItem>
                        {cooperativas.map(coop => (
                          <SelectItem key={coop.id} value={coop.id}>
                            {coop.nome}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="space-y-2">
                    <Label htmlFor="formato">Formato *</Label>
                    <Select
                      value={formData.formato}
                      onValueChange={(value) => setFormData({ ...formData, formato: value })}
                      required
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="csv">CSV</SelectItem>
                        <SelectItem value="xls">Excel (XLS)</SelectItem>
                        <SelectItem value="pdf">PDF</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div className="flex justify-end gap-3 pt-4">
                    <Button type="button" variant="outline" onClick={() => setIsFormOpen(false)}>
                      Cancelar
                    </Button>
                    <Button type="submit" className="bg-[#4A9B8E] hover:bg-[#3A7B6E]">
                      Gerar Relatório
                    </Button>
                  </div>
                </form>
              </DialogContent>
            </Dialog>
          </div>
        </CardHeader>
        <CardContent>
          <div className="rounded-lg border border-slate-200 overflow-hidden">
            <Table>
              <TableHeader>
                <TableRow className="bg-slate-50">
                  <TableHead>Tipo de Relatório</TableHead>
                  <TableHead>Período</TableHead>
                  <TableHead>Cooperativa</TableHead>
                  <TableHead>Formato</TableHead>
                  <TableHead>Data Geração</TableHead>
                  <TableHead>Registros</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead className="text-right">Ações</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {isLoading ? (
                  <TableRow>
                    <TableCell colSpan={8} className="text-center py-8 text-slate-500">
                      Carregando...
                    </TableCell>
                  </TableRow>
                ) : relatorios.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={8} className="text-center py-8 text-slate-500">
                      Nenhum relatório gerado ainda
                    </TableCell>
                  </TableRow>
                ) : (
                  relatorios.map((relatorio) => {
                    const StatusIcon = statusIcons[relatorio.status] || Clock;
                    const tipoLabel = tiposRelatorio.find(t => t.value === relatorio.tipo_relatorio)?.label || relatorio.tipo_relatorio;
                    const cooperativa = cooperativas.find(c => c.id === relatorio.cooperativa_id);
                    
                    return (
                      <TableRow key={relatorio.id} className="hover:bg-slate-50">
                        <TableCell className="font-medium">{tipoLabel}</TableCell>
                        <TableCell className="text-sm">
                          {relatorio.periodo_inicio && relatorio.periodo_fim ? (
                            `${format(new Date(relatorio.periodo_inicio), 'dd/MM/yyyy')} - ${format(new Date(relatorio.periodo_fim), 'dd/MM/yyyy')}`
                          ) : 'N/A'}
                        </TableCell>
                        <TableCell className="text-sm">{cooperativa?.nome || 'Todas'}</TableCell>
                        <TableCell>
                          <Badge variant="outline" className="uppercase">
                            {relatorio.formato}
                          </Badge>
                        </TableCell>
                        <TableCell className="text-sm">
                          {format(new Date(relatorio.created_date), 'dd/MM/yyyy HH:mm')}
                        </TableCell>
                        <TableCell className="text-sm">
                          {relatorio.total_registros ? relatorio.total_registros.toLocaleString('pt-BR') : '-'}
                        </TableCell>
                        <TableCell>
                          <Badge variant="secondary" className={`${statusColors[relatorio.status]} border gap-1`}>
                            <StatusIcon className="w-3 h-3" />
                            {relatorio.status}
                          </Badge>
                        </TableCell>
                        <TableCell className="text-right">
                          {relatorio.status === 'concluido' && relatorio.arquivo_url && (
                            <Button variant="ghost" size="sm" asChild>
                              <a href={relatorio.arquivo_url} download target="_blank" rel="noopener noreferrer">
                                <Download className="w-4 h-4" />
                              </a>
                            </Button>
                          )}
                        </TableCell>
                      </TableRow>
                    );
                  })
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {tiposRelatorio.map((tipo) => (
          <Card key={tipo.value} className="hover:shadow-lg transition-shadow">
            <CardHeader>
              <CardTitle className="text-base flex items-center gap-2">
                <FileText className="w-5 h-5 text-[#4A9B8E]" />
                {tipo.label}
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-slate-500">Gerados</p>
                  <p className="text-2xl font-bold text-slate-800">
                    {relatoriosPorTipo[tipo.value] || 0}
                  </p>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setFormData({ ...formData, tipo_relatorio: tipo.value });
                    setIsFormOpen(true);
                  }}
                >
                  Gerar
                </Button>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
}